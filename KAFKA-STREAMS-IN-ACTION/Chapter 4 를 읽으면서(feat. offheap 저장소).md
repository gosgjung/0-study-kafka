# Chapter 4 를 읽으면서(feat. offheap 저장소)



![1](./img/REMIND-CH04/2.png)





![1](./img/REMIND-CH04/1.png)



Chapter4 를 읽으면서 주식데이터처리서버를 구성할 때 offheap 저장소로 hazelcast를 구성했던게 틀린게 아니라는 것을 깨달았다. RabbitMQ 는 별도로 spring-amqp 를 사용할 때 offheap 을 사용할 수 있게하는 별도의 기능을 제공해주지 않는다. 하지만, 카프카에서는 이것을 제공해준다. 생각해보니 카프카가 기본적으로 off heap 기반이라는 것을 3년 전에 처음으로 스터디할 때 알게되었었는데, RabbitMQ만 쓰다보니 까먹은것 같다.<br>

내 경우는 RabbitMQ를 사용해서 실시간 데이터 처리를 할 때 spring-amqp 에서 별도로 off heap 저장소를 구성하는 API 를 제공해주지 않기에 모든 자료구조를 직접 개발하고, 실시간 처리를 하는 웹 애플리케이션에 해당 자료구조를 copy on write 방식으로 생산/소모하는 로직을 직접 수작업으로 개발했었다.<br>

카프카의 경우는 off heap 저장소를 접근하는 API를 빌트인으로 제공한다. 기본적으로 제공하기에, 별도로 offheap 저장소를 구성하기 위해 별도의 품을 팔지 않아도 되기에 좋고, 훨씬 더 정교하고, 경험이 많은 엔지니어들이 개발한 off heap 저장할 수 있다는 장점이 있다. <br>

이 offheap 저장소라는 것은 인메모리 데이터 그리드라고 불리기도 하고 시중에는 여러가지 저장소들이 있다. 내 경우는 프로젝트 첫 도입시에 카프카를 도입하려 했지만, RabbitMQ를 사용해야 한다는 팀장의 요구로 인해 몇번이나 카프카 도입을 이야기했으나 결국 RabbitMQ를 사용했었다. 그러면서 offheap 저장소를 사용해야 했는데, 이때 사용했던 것이 hazelcast 였다. <br>

hazelcast 를 사용하면서 비즈니스로직에 맞게끔 작업에 대한 큐를 만들어야 했다. 이 큐를 기반으로 DB INSERT 작업/웹소켓 푸시 작업을 생산/소비하게끔 하는 로직을 직접 작성하고 테스트 코드까지 일일이 작성해서 검증했다. RabbitMQ 로 주식데이터 이벤트 큐를 처리할 때는 이렇게 부가적인 모든 로직 모두 수작업으로 개발하고 테스트까지 수행해야 했었다. 공수가 너무 많이 든다.<br>

그런데!!! 카프카에서는 이 offheap 저장소에 대한 API를 빌트인으로 제공한다. 꽤 아름답지 않을 수 없다.<br>

역시 인간은 스터디를 해야 나쁜 선택을 하지 않는다. 물론, RabbitMQ를 고집한 건 내가 아니라 팀장이 계속해서 무지성으로 강요한 거라 어쩔수 없는 기술 스택 선택이었다. 카프카 도입을 굉장히 자주 이야기했는데 말할 때마다 점점 더 감정적으로 비웃거나 이런 대응뿐이라 포기했던 경험이 점점 늘어날 뿐이었다.<br>

<br>



> 면접 때 꽤 이런 질문 많다. 
>
> 왜 본인이 기술스택을 결정하지 못했냐고? 주도적으로 안했냐고? 그럼 나는 나도 설득하려 노력했지만, 팀장이 계속 RabbitMQ 를 강요했다. 이렇게 대답한다. 그럼 또 왜 본인이 결정 못 하냐고 물어본다...   그럼 나는 설득이미 많이했다. 그런데 팀장이 RabbitMQ 를 사용하라고 못박았다고 대답한다. 그럼 또 면접관은 이해 못하는 표정을 짓는다. 내 입장에서는 질문이 좀 이상하게만 들린다. 고장난 시계 같은 질문이다. 꽤 유체이탈 화법식의 반복 질문인데, 굉장히 곤란한 면접관들이 실제로 굉장히 많았다. <br>
>
> hazelcast 역시도 잘 아는 사람이 너무 없다보니 설명할 때 꽤 난감하다. redis를 왜 안썼는지? 에 대한 질문이 많다. (redis 는 원격에 분산 캐시 시스템으로 사용하는 것이고 인메모리 데이터 그리드 성격의 로컬 캐시 저장소는 아닌데, 지금까지 아무도 이 내용을 몰라서 나도 대답하는데 힘들다.)<br>
>
> 너무 답답해서 **off heap 이 뭔지 아시냐고** 면접관님께 물어본적이 있는데, **모른댄다.** 그런 경우가 실제로 존재한다.<br>
>
> 실제로 현업에서는 이렇게 팀장레벨에서 기술을 강요하는 케이스가 너무나 많다. 나중에 내가 면접관으로 참여하게 되더라도, 가만히 앉아서 정신 못차리고 면접보다보면  이런 유체이탈 화법을 하는 실수를 하게될수 있지 않을까 싶기도 하다. 내가 면접관 되면 현재 내 회사에서 사용하는 업무를 기준으로 어떤 것이 필요한지를 알수 있게끔 물어보는 그런 질문을하도록 노력해봐야지 싶다<br>

<br>



(TODO :: 예전에 offheap 관련해서 정리해둔 자료가 있기는 한데 이 문서가 어디있는지 모른다. 이 문서를 찾으면 여기에 링크를 추가해둘까 생각 중)



